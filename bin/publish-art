#!/bin/bash

# BEFORE EXECUTING this script, create and 'chmod go-rwx'
# ~/.artifactory-creds. This file will need to contain:
# declare ARTIFACTORYUSER=your-art-login
# declare ARTIFACTORYPASSWORD=your-art-password

source ~/.artifactory-creds
 
ORG_ID="com/dell/spe/mres"
ARTIFACT_ID="$(cat .app-name)"
REVISION=$(cat .revision)
QUALIFIER=$1

function publish_art()
{
    local -r target="${1:?}"
    local file="deploy/$(basename "$target")"
      
    if [ `uname` = "Darwin" ]; then
      local md5Value="$(md5 -q "$file")"
      local sha1Value="$(shasum "$file")"
    else
      local md5Value="$(md5sum "$file")"
      local sha1Value="$(sha1sum "$file")"
    fi

    md5Value="${md5Value:0:32}"
    sha1Value="${sha1Value:0:40}"
   
    local -r url="https://afeoscyc-mw.cec.lab.emc.com/artifactory/cyclone-devops-mw/$target"
   
    echo "INFO: Uploading $file to $url"
    curl -k -X PUT -u $ARTIFACTORYUSER:$ARTIFACTORYPASSWORD \
         -H "X-Checksum-Md5: $md5Value" \
         -H "X-Checksum-Sha1: $sha1Value" \
         -T "$file" \
         $url
}

if [ $QUALIFIER ]; then
   publish_art "$ORG_ID/$ARTIFACT_ID/$REVISION/$ARTIFACT_ID-$REVISION-$QUALIFIER.jar"
else
   publish_art "$ORG_ID/$ARTIFACT_ID/$REVISION/$ARTIFACT_ID-$REVISION.jar"
fi

publish_art "$ORG_ID/$ARTIFACT_ID/$REVISION/$ARTIFACT_ID-$REVISION.pom"

# To retrieve manually:
#     curl -u corp-id https://afeoscyc-mw.cec.lab.emc.com/artifactory/cyclone-devops-mw/com/dell/spe/mres/uS-lib/v0.0-5-g503e219/uS-lib-v0.0-5-g503e219.jar -o some.jar
#           OR
#     curl -u corp-id:password https://afeoscyc-mw.cec.lab.emc.com/artifactory/cyclone-devops-mw/com/dell/spe/mres/uS-lib/v0.0-5-g503e219/uS-lib-v0.0-5-g503e219.jar -o some.jar
